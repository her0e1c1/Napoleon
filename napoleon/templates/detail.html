{% extends "base.html" %}

{% block javascript %}
 <script type="text/javascript" src="{{ static('js/game.js') }}"></script>
{% endblock %}


{% macro message() %}
  <div ng-if="!game.phase" ng-switch="!game.is_joined">
    <span ng-switch-when="true">ナポレオンに参加しますか？</span>
    <span ng-switch-when="false">プレイヤーの参加待ちです...</span>
  </div>
  <div ng-if="game.phase == 'declare'" ng-switch="!game.is_passed">
    <span ng-switch-when="true">ナポレオンの宣言をしますか？</span>
    <span ng-switch-when="false">パスしました</span>
  </div>
  <div ng-if="game.phase == 'adjutant'" ng-switch="game.is_napoleon">
    <span ng-switch-when="true">副官を選択してください。</span>
    <span ng-switch-when="false">副官の選択中...</span>
  </div>
  <div ng-if="game.phase == 'discard'">
    <div ng-if="game.is_napoleon">
      <span ng-if="!game.is_unused_careds_selected()">不要なカードを選択してください</span>
      <span ng-if="game.is_unused_careds_selected()">始めに場に出すカードを選択してください</span>
    </div>
    <div ng-if="!game.is_napoleon">
      ナポレオンがカードの交換中...
    </div>
  </div>
  <div ng-if="game.waiting_next_turn" ng-class="{alert alert-success: game.is_my_turn, alert alert-danger: !game.is_my_turn}">
    [[ game.users[game.turn].name ]] [[ game.player_cards[game.turn].str ]]の勝ち
  </div>
  <div ng-if="(game.phase == 'first_round' || game.phase == 'rounds') && game.is_my_turn"  class="alert alert-info" role="alert">あなたの番です</div>
  <p ng-if="game.impossible_card" class="alert alert-warning" role="alert">[[ game.impossible_card.str]]は選べません</p>
  <div ng-if="game.phase == 'finished'">
      <span ng-if="game.did_napoleon_win">ナポレオンの勝ち</span>
      <span ng-if="game.did_napoleon_lose">ナポレオンの負け</span>
  </div>
{% endmacro %}


{% macro declaration() %}
<div class="row">
  <div ng-if="!game.phase">
    <button ng-if="game.is_joined" ng-click="game.quit()" class="btn btn-default">不参加</button>
    <button ng-if="!game.is_joined" ng-click="game.join()" class="btn btn-default">参加</button>
    <button ng-if="game.is_appropriate_player_number" ng-click="game.start()" class="btn btn-primary">開始</button>
  </div>

  <div ng-if="game.phase == 'declare'" class="col-md-2 col-xs-2">

   宣言
  <button ng-if="!game.is_napoleon" ng-disabled="game.is_passed" ng-click="game.pass()" class="btn btn-default">パス</button>

  <select ng-model="game.declaration" ng-disabled="game.is_napoleon || game.is_passed" ng-change="game.declare()" class="form-control">
    <option ng-repeat="d in game.declarations" ng-if="!game.declaration || d.value > game.declaration.value" value="[[ d.value ]]">[[ d.str ]]</option>
  </select>
  </div>

  <div ng-if="game.phase == 'adjutant' && game.is_napoleon">
    副官
    <select ng-model="game.adjutant" ng-change="game.determine_adjutant()">
      <option ng-repeat="d in game.deck" value="[[ d.value ]]">[[ d.str ]]</option>
    </select>
  </div>
</div>

{% endmacro %}


{% block content %}
  <div ng-controller="GameController as game"
       ng-init="
       game.user_id={{ request.user.id }};
       game.game_id={{ game.id }};
       game.deck={{ deck }};
       game.declarations={{ declarations }};
       ">

     <dl class="dl-horizontal">
      <dt>宣言</dt>
      <dd>[[ game.declaration.str ]]</dd>
      <dt>副官</dt>
      <dd>[[ game.adjutant.str ]]</dd>
    </dl>

    <div id="player_ids">
      <table class="table table-bordered">
        <tr id="player">
          <th>Players</th>
          <td ng-repeat="p in game.player_ids track by $index" ng-class="{active: p == game.turn}">
            <span ng-if="p == game.user_id" class="glyphicon glyphicon-star"></span>
            <strong class="text-info">
              [[ game.users[p].name ]]
              <span ng-if="game.player_faces[p] !== null">([[ game.player_faces[p] ]])</span>
            </strong>
            <span ng-if="p == game.napoleon" class="label label-info">N</span>
            <span ng-if="game.phase == 'declare' && game.pass_ids.indexOf(p) >= 0" class="label label-default">PASS</span>
          </td>
        </tr>
        <tr>
          <th>Board</th>
          <td ng-repeat="pid in game.player_ids track by $index">[[ game.player_cards[pid].str ]]</td>
        </tr>
      </table>
    </div>

    <ul ng-if="game.phase == 'first_round'" class="list-inline">
      <td>first round face cards</td>
      <li ng-repeat="c in game.unused">[[ c.str ]]</li>
    </ul>

    <ul ng-if="game.phase == 'discard'" class="list-inline">
      <td>Selected</td>
      <li ng-repeat="c in game.unused" ng-click="game.unselect(c)"><button class="btn btn-info">[[ c.str ]]</button></li>
    </ul>


    {{ message() }}

    <div id="hand">
      <ul class="list-inline"><li ng-repeat="c in game.hand.concat(game.rest) | orderBy:'order_by_suit' track by $index">
          <button ng-click="game.select_or_discard(c)" class="btn btn-default">[[ c.str ]]</button>
      </li></ul>
    </div>

    {{ declaration() }}
  </div>
{% endblock %}
