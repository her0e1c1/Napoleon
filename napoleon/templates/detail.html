{% extends "base.html" %}

{% block javascript %}
 <script type="text/javascript">
   var csrf_token = "{{ csrf_token }}";
   var user_id={{ request.user.id }};
   var urls = {
     "state": "{{ url('napoleon.room.views.game_state', kwargs={'room_id': room.id})  }}",
     "join": "{{ url('napoleon.room.views.join', kwargs={'room_id': room.id}) }}",
     "quit": "{{ url('napoleon.room.views.quit', kwargs={'room_id': room.id}) }}",
     "room": "ws://" + location.host + "/ws/{{ room.id }}",
   };
 </script>
 <script type="text/javascript" src="{{ static('js/game.js') }}"></script>
{% endblock %}


{% macro message() %}
  <div ng-if="game.myself.is_player && !game.myself.is_valid" class="alert alert-danger" role="alert">
    Your session is invalid<br>
    You probably logged out or logged in on another browser,
    so you need to create a new room if you want to play.
    <br>
    <form action="{{ url('napoleon.room.views.reset', kwargs={'room_id': room.id}) }}" method="post">
      {{ csrf_input }}
      Or you can reset your session on this room.
      <input type="submit" value="reset">
    </form>
  </div>
  <div ng-if="game.is_error" class="alert alert-danger" role="alert">
    Connection Error<br>
    Please tell an administrator <a href="{{ url('napoleon.contact.views.index') }}">here</a>
  </div>
  <div ng-if="game.is_close" class="alert alert-warning" role="alert">
    Connection Closed<br>
    Please reload again
  </div>
  <div ng-if="!game.phase" ng-switch="!game.myself.is_joined">
    <span ng-switch-when="true">Do you want to paly Napoleon?</span>
    <span ng-switch-when="false">Waiting for other players to join ...</span>
  </div>
  <div ng-if="game.phase == 'declare'" ng-switch="!game.myself.is_passed">
    <span ng-switch-when="true">Do you declare as Napoleon?</span>
    <span ng-switch-when="false">passed</span>
  </div>
  <div ng-if="game.phase == 'adjutant'" ng-switch="game.myself.is_napoleon">
    <span ng-switch-when="true">Decide an adjutant</span>
    <span ng-switch-when="false">Napoleon is deciding an adjutant...</span>
  </div>
  <div ng-if="game.phase == 'discard'">
    <div ng-if="game.myself.is_napoleon">
      <span ng-if="!game.phases.is_unused_careds_selected()">Select unnecessary cards</span>
    </div>
    <div ng-if="!game.myself.is_napoleon">
      Napoleon is exchanging the cards ...
    </div>
  </div>
  <div ng-if="game.phases.waiting_next_turn" ng-class="{'alert alert-success': game.myself.is_my_turn, 'alert alert-danger': !game.myself.is_my_turn}">
    [[ game.users[game.turn.user_id].name ]] [[ game.player_cards[game.turn.user_id].str ]] won
  </div>
  <div ng-if="(game.phase == 'first_round' || game.phase == 'rounds') && game.myself.is_my_turn"  class="alert alert-info" role="alert">It's your turn</div>
  <p ng-if="game.impossible_card" class="alert alert-warning" role="alert">You can't select [[ game.impossible_card.str]]</p>
  <div ng-if="game.phase == 'finished'">
      <div ng-if="game.phases.did_napoleon_forces_win" ng-class="{'alert alert-success': game.role == 1, 'alert alert-danger': game.role != 1}">Napoleon won!</div>
      <div ng-if="game.phases.did_allied_forces_win" ng-class="{'alert alert-success': game.role != 1, 'alert alert-danger': game.role == 1}" >Allied forces won!</div>
  </div>
{% endmacro %}

{% macro start() %}
  <div ng-if="!game.state.phase">
    <button ng-if="game.myself.is_joined" ng-click="game.quit()" class="btn btn-default">Leave</button>
    <button ng-if="!game.myself.is_joined" ng-click="game.join()" class="btn btn-default">Play</button>
    <button ng-if="game.state.phases.is_appropriate_player_number" ng-click="game.start()" class="btn btn-primary">Start</button>
  </div>
{% endmacro %}

{% macro declaration() %}
  <div ng-if="game.state.phase == 'declare'">
    <div class="form-inline">
      <div class="form-group">
        <label>Declaration</label>
        <select ng-model="game.declaration" ng-disabled="game.myself.is_napoleon || game.myself.is_passed" ng-change="game.declare()" class="form-control">
          <option ng-repeat="d in {{ declarations }}" ng-if="!game.state.declaration || d.value > game.state.declaration.value" value="[[ d.value ]]">[[ d.str ]]</option>
        </select>
      </div>
      <div class="form-group">
        <label class="sr-only">Pass</label>
        <button ng-if="!game.myself.is_napoleon" ng-disabled="game.myself.is_passed" ng-click="game.pass()" class="btn btn-default form-control">Pass</button>
      </div>
    </div>
  </div>

  <div ng-if="game.state.phase == 'adjutant' && game.myself.is_napoleon">
    <div class="form-inline">
      <div class="form-group">
        <label>Adjutant</label>
        <select ng-model="game.adjutant" ng-change="game.determine_adjutant()" class="form-control">
          <option ng-repeat="d in {{ deck }}" value="[[ d.value ]]">[[ d.str ]]</option>
        </select>
      </div>
    </div>
  </div>
{% endmacro %}


{% block content %}
  <div ng-controller="GameController as game">

  <table class="table table-condensed">
    <tr>
      <th class="col-xs-1 info">Declaration</th>
      <td>[[ game.declaration.str ]]</td>
    </tr>
    <tr>
      <th class="col-xs-1 info">Adjutant</th>
      <td>[[ game.adjutant.str ]]</td>
    </tr>
  </table>

    <div id="player_ids">
      <table class="table table-bordered">
        <tr id="player">
          <th>Players</th>
          <td ng-repeat="p in game.state.players track by $index" ng-class="{active: p.user_id == game.turn.user_id}">
            <span ng-if="p.user_id == game.myself.user_id" class="glyphicon glyphicon-star"></span>
            <strong class="text-info">
              [[ game.users[p.user_id].name ]]
              <span ng-if="game.player_faces[p.user_id] !== null">([[ p.face ]])</span>
              C([[p.number_of_hand ]])
            </strong>
            <span ng-if="p.is_napoleon" class="label label-info">N</span>
            <span ng-if="game.state.phases.current == 'declare' && p.is_passed" class="label label-default">PASS</span>
          </td>
        </tr>
        <tr>
          <th>Board</th>
          <td ng-repeat="p in game.state.players track by $index">[[ game.state.player_cards[p.user_id].str ]]</td>
        </tr>
      </table>
    </div>

    <ul ng-if="game.phase == 'first_round'" class="list-inline">
      <span class="label label-info">Face Cards</span>
      <li ng-repeat="c in game.state.unused_faces">[[ c.str ]]</li>
    </ul>

    <ul ng-if="game.phase == 'discard'" class="list-inline">
      <span class="label label-default">Selected</span>
      <li ng-repeat="c in game.unused" ng-click="game.unselect(c)"><button class="btn btn-default">[[ c.str ]]</button></li>
    </ul>

    {{ message() }}
    {{ start() }}
    {{ declaration() }}

    <div id="hand">
      <ul class="list-inline"><li ng-repeat="c in game.myself.hand | orderBy:'order_by_suit' track by $index">
          <button ng-click="game.select_or_discard(c)" ng-disabled="!game.myself.is_my_turn" class="btn btn-default">[[ c.str ]]</button>
      </li></ul>
    </div>

  </div>
{% endblock %}
